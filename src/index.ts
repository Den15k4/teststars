import { Telegraf, Context } from 'telegraf';
import axios from 'axios';
import dotenv from 'dotenv';

dotenv.config();

if (!process.env.BOT_TOKEN) {
    throw new Error('BOT_TOKEN is required in .env file');
}

const bot = new Telegraf(process.env.BOT_TOKEN);
const TELEGRAM_API = `https://api.telegram.org/bot${process.env.BOT_TOKEN}`;

interface LabeledPrice {
    label: string;
    amount: number;
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð½Ð¾Ð¹ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹
function getPaymentKeyboard() {
    return {
        inline_keyboard: [
            [{
                text: "ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ 20 â­ï¸",
                pay: true
            }]
        ]
    };
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.command('start', async (ctx) => {
    try {
        console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° /start Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', ctx.from?.id);
        
        const prices: LabeledPrice[] = [
            { label: "XTR", amount: 20 }
        ];

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ invoice
        await ctx.telegram.sendInvoice(ctx.chat.id, {
            title: "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÐºÐ°Ð½Ð°Ð»Ð°",
            description: "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÐºÐ°Ð½Ð°Ð» Ð½Ð° 20 Ð·Ð²Ñ‘Ð·Ð´!",
            payload: "channel_support",
            currency: "XTR",
            prices: prices,
            provider_token: "", // Ð”Ð»Ñ Telegram Stars Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑÑ‚Ñ‹Ð¼
            reply_markup: getPaymentKeyboard()
        });
        
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ start:', error);
        if (axios.isAxiosError(error)) {
            console.error('ÐžÑ‚Ð²ÐµÑ‚ API:', error.response?.data);
        }
        await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ñ€Ðµ-Ñ‡ÐµÐºÐ°ÑƒÑ‚Ð°
bot.on('pre_checkout_query', async (ctx) => {
    try {
        await ctx.answerPreCheckoutQuery(true);
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ðµ-Ñ‡ÐµÐºÐ°ÑƒÑ‚Ðµ:', error);
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°
bot.on('successful_payment', async (ctx) => {
    try {
        await ctx.reply('ðŸŒŸ Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð²Ð°ÑˆÑƒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ! ðŸŒŸ');
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°:', error);
    }
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /paysupport
bot.command('paysupport', async (ctx) => {
    await ctx.reply(
        'Ð”Ð¾Ð±Ñ€Ð¾Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð¶ÐµÑ€Ñ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ðµ Ð¿Ð¾Ð´Ñ€Ð°Ð·ÑƒÐ¼ÐµÐ²Ð°ÑŽÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÑÑ€ÐµÐ´ÑÑ‚Ð², ' +
        'Ð¾Ð´Ð½Ð°ÐºÐ¾, ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð¾Ñ‡ÐµÐ½ÑŒ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° - ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸.'
    );
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.launch().then(() => {
    console.log('Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
}).catch((err) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð±Ð¾Ñ‚Ð°:', err);
});

// Graceful shutdown
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));